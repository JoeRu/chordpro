<?xml version="1.0" encoding="UTF-8"?>
<project-overview>
  <metadata>
    <title>ChordPro</title>
    <version>6.090_040</version>
    <analyzed>2026-02-08</analyzed>
    <updated>2026-02-08</updated>
    <repository>https://github.com/ChordPro/chordpro</repository>
  </metadata>

  <architecture>
    <description>
      ChordPro follows a Parse -> Transform -> Render pipeline. Song.pm parses .cho files into
      element arrays, Chords/*.pm handles transposition and notation conversion, and Output/*.pm
      backends render the songbook. CLI entry is script/chordpro.pl; GUI entry is
      script/wxchordpro.pl (wxWidgets).

      Two backend styles coexist: modern Object::Pad classes (HTML5, Markdown, Meta) and legacy
      procedural backends (PDF, HTML, Text, LaTeX, MMA, ChordPro, JSON, Debug).

      Configuration is JSON-based with hierarchical merging: builtin -> sysconfig -> userconfig
      -> CLI --define. Config/Data.pm is generated from lib/ChordPro/res/config/chordpro.json via
      script/cfgboot.pl. Resources (fonts, templates, configs) resolve via ChordPro::Paths.
      Template::Toolkit drives HTML5 and LaTeX output. Delegates handle external notation
      (ABC via embedded QuickJS/abc2svg, LilyPond via external binary, Grille/Strum/SVG).
    </description>
    <patterns>
      <pattern>Parse-Transform-Render pipeline</pattern>
      <pattern>Object::Pad OOP for modern backends</pattern>
      <pattern>Handler registry dispatch in ChordProBase</pattern>
      <pattern>Template::Toolkit for HTML5/LaTeX templates</pattern>
      <pattern>JSON config with hierarchical merge and restricted hashes</pattern>
      <pattern>Delegate pattern for external notation systems</pattern>
      <pattern>Resource resolution via Paths.pm</pattern>
    </patterns>
    <system-requirements>
      <requirement>Perl 5.26+</requirement>
      <requirement>ExtUtils::MakeMaker 7.24+</requirement>
    </system-requirements>
    <external-dependencies>
      <dependency>Object::Pad 0.818+</dependency>
      <dependency>PDF::API2 2.045+ (or PDF::Builder via CHORDPRO_PDF_API)</dependency>
      <dependency>JavaScript::QuickJS 0.18+ (embedded abc2svg)</dependency>
      <dependency>HarfBuzz::Shaper 0.026+ and Text::Layout 0.045+</dependency>
      <dependency>JSON::XS 4.03+ and JSON::Relaxed</dependency>
      <dependency>Image::Info 1.41+</dependency>
      <dependency>File::LoadLines 1.047</dependency>
      <dependency>String::Interpolate::Named 1.060</dependency>
      <dependency>Data::Printer 1.001001</dependency>
      <dependency>File::HomeDir 1.004</dependency>
      <dependency>IPC::Run3 0.049</dependency>
      <dependency>LWP::Protocol::https 6.14 and Mozilla::CA 20230801</dependency>
      <dependency>Ref::Util 0.204</dependency>
      <dependency>Unicode::Collate 1.31 and Unicode::Normalize 1.26</dependency>
      <dependency>Optional: Template 3.010 and LaTeX::Encode 0.092.0 (LaTeX backend)</dependency>
      <dependency>Optional: LilyPond binary (delegate)</dependency>
      <dependency>Bundled: paged.js for HTML5 print mode</dependency>
      <dependency>Docs: Hugo (uses Go 1.18 module for search indexing)</dependency>
    </external-dependencies>
    <interfaces>
      <interface type="inbound">CLI: script/chordpro.pl parses .cho files and writes output</interface>
      <interface type="inbound">GUI: script/wxchordpro.pl (wxWidgets frontend)</interface>
      <interface type="inbound">Config: JSON config files and CLI --define overrides</interface>
      <interface type="outbound">PDF output via PDF::API2 (or PDF::Builder)</interface>
      <interface type="outbound">HTML5 output via Template::Toolkit (responsive/screen/print)</interface>
      <interface type="outbound">Markdown, LaTeX, Text, HTML, JSON, MMA, ChordPro outputs</interface>
      <interface type="outbound">SVG chord diagrams via Output/ChordDiagram/SVG.pm</interface>
      <interface type="outbound">Delegates: abc2svg, LilyPond, Grille, Strum, SVG</interface>
    </interfaces>
    <design-decisions>
      <decision date="2026-02-08">Object::Pad chosen for modern backends to keep dependencies light.</decision>
      <decision date="2026-02-08">Template::Toolkit used for HTML5/LaTeX to separate markup from logic.</decision>
      <decision date="2026-02-08">Restricted hashes from JSON::Relaxed used to catch config typos at runtime.</decision>
      <decision date="2026-02-08">Backend-owned structurization: backends call structurize() as needed.</decision>
      <decision date="2026-02-08">Bundled abc2svg via QuickJS to avoid external runtime dependency for ABC.</decision>
      <decision date="2026-02-08">SVG chord diagrams render at em-based sizing to match fonts.</decision>
      <decision date="2026-02-08">HTML5 output embeds images as base64 data URIs for portability.</decision>
    </design-decisions>
  </architecture>

  <environments>
    <environment name="dev">Dev container via .devcontainer/devcontainer.json (Dockerfile, VARIANT=5), PERL5LIB=/workspace/lib, workspace mounted at /workspace and /data.</environment>
    <environment name="docs">Docs site built with Hugo in docs/ (see docs/Makefile).</environment>
    <environment name="staging">Not documented in repo.</environment>
    <environment name="prod">Not documented in repo.</environment>
  </environments>

  <security>
    <concern>
      <threat>External delegate execution may run external programs with user-supplied inputs.</threat>
      <risk>MEDIUM</risk>
      <vulnerability>Delegate/Program.pm executes external programs; unsafe args could lead to command injection.</vulnerability>
      <mitigation>Validate and sanitize delegate inputs and file paths before execution.</mitigation>
    </concern>
    <concern>
      <threat>Fetching resources over HTTPS can be abused for SSRF if URLs are user-controlled.</threat>
      <risk>MEDIUM</risk>
      <vulnerability>Config/resource fetching via LWP::Protocol::https may allow outbound requests to internal hosts.</vulnerability>
      <mitigation>Restrict allowed URL schemes/hosts or require local-only resources by default.</mitigation>
    </concern>
  </security>

  <completed-features>
    <feature id="CF-1" completed="2026-02-08" completeness="PARTIAL" test-coverage="PARTIAL" ref-item="1">
      <title>CLI pipeline and backend selection</title>
      <description>Reads .cho inputs, resolves output backend, and coordinates parsing and rendering.</description>
      <files>
        <file>lib/ChordPro.pm</file>
        <file>script/chordpro.pl</file>
        <file>lib/ChordPro/Songbook.pm</file>
      </files>
      <test-files>
        <file>t/00_basic.pl</file>
        <file>t/10_files.t</file>
        <file>t/100_basic.t</file>
      </test-files>
      <gaps>
        <gap>CLI option edge cases and filelist parsing not fully mapped.</gap>
      </gaps>
    </feature>

    <feature id="CF-2" completed="2026-02-08" completeness="PARTIAL" test-coverage="PARTIAL" ref-item="2">
      <title>Song parser and directives</title>
      <description>Parses ChordPro directives, builds song element arrays, and tracks metadata.</description>
      <files>
        <file>lib/ChordPro/Song.pm</file>
        <file>lib/ChordPro/Songbook.pm</file>
      </files>
      <test-files>
        <file>t/101_directives.t</file>
        <file>t/114_songline.t</file>
        <file>t/116_chorus.t</file>
      </test-files>
      <gaps>
        <gap>Edge directives and metadata normalization are not fully documented.</gap>
      </gaps>
    </feature>

    <feature id="CF-3" completed="2026-02-08" completeness="PARTIAL" test-coverage="PARTIAL" ref-item="3">
      <title>Chord parsing, notation, and transposition</title>
      <description>Parses chord tokens, handles notation systems, and applies transposition.</description>
      <files>
        <file>lib/ChordPro/Chords.pm</file>
        <file>lib/ChordPro/Chords/</file>
      </files>
      <test-files>
        <file>t/105_chords.t</file>
        <file>t/170_transpose.t</file>
        <file>t/110_chords_roman.t</file>
      </test-files>
      <gaps>
        <gap>Notation edge cases and alternate naming systems need deeper mapping.</gap>
      </gaps>
    </feature>

    <feature id="CF-4" completed="2026-02-08" completeness="FULL" test-coverage="TESTED">
      <title>HTML5 output backend</title>
      <description>Renders HTML5 output with screen and print modes using templates and paged.js.</description>
      <files>
        <file>lib/ChordPro/Output/HTML5.pm</file>
        <file>lib/ChordPro/Output/HTML5Helper/</file>
        <file>lib/ChordPro/res/templates/html5/</file>
      </files>
      <test-files>
        <file>t/html5/</file>
        <file>t/html5paged/</file>
        <file>t/190_html5_bugfixes.t</file>
      </test-files>
    </feature>

    <feature id="CF-5" completed="2026-02-08" completeness="PARTIAL" test-coverage="PARTIAL" ref-item="4">
      <title>Legacy and auxiliary output backends</title>
      <description>PDF, HTML, Text, LaTeX, JSON, MMA, ChordPro, Debug, and Meta output formats.</description>
      <files>
        <file>lib/ChordPro/Output/PDF.pm</file>
        <file>lib/ChordPro/Output/HTML.pm</file>
        <file>lib/ChordPro/Output/Text.pm</file>
        <file>lib/ChordPro/Output/LaTeX.pm</file>
        <file>lib/ChordPro/Output/JSON.pm</file>
        <file>lib/ChordPro/Output/MMA.pm</file>
        <file>lib/ChordPro/Output/ChordPro.pm</file>
        <file>lib/ChordPro/Output/Debug.pm</file>
        <file>lib/ChordPro/Output/Meta.pm</file>
      </files>
      <gaps>
        <gap>Feature parity and edge-case handling across legacy backends not fully documented.</gap>
      </gaps>
    </feature>

    <feature id="CF-6" completed="2026-02-08" completeness="PARTIAL" test-coverage="UNKNOWN" ref-item="5">
      <title>Markdown output backend</title>
      <description>Renders song output to Markdown via Object::Pad backend.</description>
      <files>
        <file>lib/ChordPro/Output/Markdown.pm</file>
      </files>
      <gaps>
        <gap>Handler coverage for diagrams, delegates, and grids not fully mapped.</gap>
      </gaps>
    </feature>

    <feature id="CF-7" completed="2026-02-08" completeness="PARTIAL" test-coverage="PARTIAL" ref-item="6">
      <title>Chord diagrams and grids</title>
      <description>Chord diagram rendering and grid/measure layout across backends.</description>
      <files>
        <file>lib/ChordPro/Output/ChordDiagram/</file>
        <file>lib/ChordPro/res/fonts/ChordProSymbols.ttf</file>
      </files>
      <test-files>
        <file>t/160_diagrams.t</file>
        <file>t/180_grids.t</file>
      </test-files>
      <gaps>
        <gap>Diagram rendering variants and keyboard diagrams need full mapping.</gap>
      </gaps>
    </feature>

    <feature id="CF-8" completed="2026-02-08" completeness="PARTIAL" test-coverage="NONE" ref-item="7">
      <title>External delegate integration</title>
      <description>Delegates render ABC, LilyPond, SVG, Grille, Strum, and text blocks.</description>
      <files>
        <file>lib/ChordPro/Delegate/ABC.pm</file>
        <file>lib/ChordPro/Delegate/Lilypond.pm</file>
        <file>lib/ChordPro/Delegate/Grille.pm</file>
        <file>lib/ChordPro/Delegate/Strum.pm</file>
        <file>lib/ChordPro/Delegate/SVG.pm</file>
        <file>lib/ChordPro/Delegate/TextBlock.pm</file>
        <file>lib/ChordPro/Delegate/Program.pm</file>
      </files>
      <gaps>
        <gap>Delegate IO contracts and error handling are not fully documented or tested.</gap>
      </gaps>
    </feature>

    <feature id="CF-9" completed="2026-02-08" completeness="PARTIAL" test-coverage="UNKNOWN" ref-item="8">
      <title>Wx GUI application</title>
      <description>WxWidgets-based GUI for editing, previewing, and printing.</description>
      <files>
        <file>script/wxchordpro.pl</file>
        <file>lib/ChordPro/Wx/</file>
      </files>
      <gaps>
        <gap>GUI workflows, state handling, and test coverage not fully mapped.</gap>
      </gaps>
    </feature>

    <feature id="CF-10" completed="2026-02-08" completeness="PARTIAL" test-coverage="UNKNOWN" ref-item="9">
      <title>Configuration system and resource resolution</title>
      <description>JSON config hierarchy, generated config data, and resource path lookup.</description>
      <files>
        <file>lib/ChordPro/Config.pm</file>
        <file>lib/ChordPro/Config/Data.pm</file>
        <file>lib/ChordPro/res/config/chordpro.json</file>
        <file>script/cfgboot.pl</file>
        <file>lib/ChordPro/Paths.pm</file>
      </files>
      <gaps>
        <gap>Config precedence edge cases and validation behavior need documentation.</gap>
      </gaps>
    </feature>

    <feature id="CF-11" completed="2026-02-08" completeness="PARTIAL" test-coverage="NONE" ref-item="10">
      <title>Documentation site (Hugo)</title>
      <description>Static documentation site built with Hugo and pagefind search.</description>
      <files>
        <file>docs/Makefile</file>
        <file>docs/config/</file>
        <file>docs/content/</file>
        <file>docs/layouts/</file>
      </files>
      <gaps>
        <gap>Doc coverage for advanced configuration and backend-specific behavior is partial.</gap>
      </gaps>
    </feature>
  </completed-features>
</project-overview>
