<?xml version="1.0" encoding="UTF-8"?>
<implementation-plan>
  <metadata>
    <title>ChordPro Feature and Bug Plan</title>
    <version>3.1</version>
    <date>2026-02-08</date>
    <updated>2026-02-10</updated>
    <status>Initial code analysis (2026-02-08)</status>
    <summary>
      Initial analysis of the ChordPro codebase. Established architecture, dependencies, and
      feature inventory. Created reference items for incomplete feature mapping and test
      coverage gaps.
    </summary>
  </metadata>

  <items>
    <item id="1" type="refactoring" status="PENDING" priority="MEDIUM" complexity="M" ref-feature="CF-1">
      <title>[REF] CLI pipeline mapping and coverage</title>
      <justification><![CDATA[
Core CLI flow is partially mapped. Output selection, filelist parsing, and progress callbacks
are critical paths with limited documented behavior and edge-case coverage.
]]></justification>
      <depends-on></depends-on>
      <tasks>
        <task id="1.1"><![CDATA[Map CLI option handling and output backend selection paths.]]></task>
        <task id="1.2"><![CDATA[Document filelist parsing and progress callback behavior.]]></task>
        <task id="1.3"><![CDATA[Add tests for output selection and filelist edge cases.]]></task>
      </tasks>
      <verification>
        <tests>
          <test type="unit">
            <file>t/10_files.t</file>
            <description>Filelist parsing edge cases.</description>
            <assertions>Filelist parsing matches documented behavior across quoting and options.</assertions>
          </test>
        </tests>
      </verification>
    </item>

    <item id="2" type="refactoring" status="PENDING" priority="MEDIUM" complexity="M" ref-feature="CF-2">
      <title>[REF] Song parser and directives mapping</title>
      <justification><![CDATA[
Directive coverage is broad but not fully mapped. Edge directives and metadata normalization
behavior need documentation and tests.
]]></justification>
      <depends-on></depends-on>
      <tasks>
        <task id="2.1"><![CDATA[Catalog directive handlers and map to element output.]]></task>
        <task id="2.2"><![CDATA[Document metadata normalization and directive precedence.]]></task>
        <task id="2.3"><![CDATA[Add tests for edge directives and mixed metadata cases.]]></task>
      </tasks>
      <verification>
        <tests>
          <test type="unit">
            <file>t/101_directives.t</file>
            <description>Directive parsing coverage expansion.</description>
            <assertions>Directive outputs match documented element structure.</assertions>
          </test>
        </tests>
      </verification>
    </item>

    <item id="3" type="refactoring" status="PENDING" priority="MEDIUM" complexity="M" ref-feature="CF-3">
      <title>[REF] Chord parsing and transposition mapping</title>
      <justification><![CDATA[
Chord parsing supports multiple notation systems and transposition rules that are not fully
mapped, increasing regression risk for notation-specific features.
]]></justification>
      <depends-on></depends-on>
      <tasks>
        <task id="3.1"><![CDATA[Document chord token parsing and naming conventions.]]></task>
        <task id="3.2"><![CDATA[Map transposition rules and notation-specific conversions.]]></task>
        <task id="3.3"><![CDATA[Add tests for roman, nashville, and solfege edge cases.]]></task>
      </tasks>
      <verification>
        <tests>
          <test type="unit">
            <file>t/110_chords_roman.t</file>
            <description>Chord notation edge cases.</description>
            <assertions>Notation conversions produce expected symbols and accidentals.</assertions>
          </test>
        </tests>
      </verification>
    </item>

    <item id="4" type="refactoring" status="PENDING" priority="LOW" complexity="M" ref-feature="CF-5">
      <title>[REF] Legacy and auxiliary backend parity</title>
      <justification><![CDATA[
Legacy backends vary in feature coverage. Without a parity matrix, regressions are hard to
detect and behavior differences are undocumented.
]]></justification>
      <depends-on></depends-on>
      <tasks>
        <task id="4.1"><![CDATA[Inventory element handlers across PDF/HTML/Text/LaTeX/JSON/MMA/ChordPro/Debug/Meta.]]></task>
        <task id="4.2"><![CDATA[Document known gaps and intended behavior differences.]]></task>
        <task id="4.3"><![CDATA[Add baseline tests for at least PDF and Text output.]]></task>
      </tasks>
      <verification>
        <tests>
          <test type="unit">
            <file>t/100_basic.t</file>
            <description>Baseline backend output checks.</description>
            <assertions>Selected backends render core song elements without errors.</assertions>
          </test>
        </tests>
      </verification>
    </item>

    <item id="5" type="refactoring" status="PENDING" priority="MEDIUM" complexity="M" ref-feature="CF-6">
      <title>[REF] Markdown backend coverage</title>
      <justification><![CDATA[
Markdown backend handler coverage and representations for diagrams and delegates are not
fully documented or tested.
]]></justification>
      <depends-on></depends-on>
      <tasks>
        <task id="5.1"><![CDATA[Audit Markdown handler coverage against ChordProBase elements.]]></task>
        <task id="5.2"><![CDATA[Define representation for diagrams, grids, and delegate outputs.]]></task>
        <task id="5.3"><![CDATA[Add or extend tests for Markdown output coverage.]]></task>
      </tasks>
      <verification>
        <tests>
          <test type="unit">
            <file>t/73_md.t</file>
            <description>Markdown output coverage tests.</description>
            <assertions>All core elements have valid Markdown representations.</assertions>
          </test>
        </tests>
      </verification>
    </item>

    <item id="6" type="refactoring" status="PENDING" priority="MEDIUM" complexity="M" ref-feature="CF-7">
      <title>[REF] Chord diagrams and grids mapping</title>
      <justification><![CDATA[
Diagram and grid rendering involve multiple components and font resources. Coverage and
variants (keyboard diagrams, repeats) are only partially mapped.
]]></justification>
      <depends-on></depends-on>
      <tasks>
        <task id="6.1"><![CDATA[Map diagram generation flow and SVG rendering paths.]]></task>
        <task id="6.2"><![CDATA[Document grid syntax handling and repeat markers.]]></task>
        <task id="6.3"><![CDATA[Add tests for keyboard diagrams and grid repeats.]]></task>
      </tasks>
      <verification>
        <tests>
          <test type="unit">
            <file>t/160_diagrams.t</file>
            <description>Diagram rendering coverage.</description>
            <assertions>Diagram outputs match expected SVG or textual format.</assertions>
          </test>
        </tests>
      </verification>
    </item>

    <item id="7" type="refactoring" status="PENDING" priority="MEDIUM" complexity="M" ref-feature="CF-8">
      <title>[REF] Delegate integration contracts</title>
      <justification><![CDATA[
Delegate integration relies on external tools and internal IO contracts that are not fully
specified, with minimal automated coverage.
]]></justification>
      <depends-on></depends-on>
      <tasks>
        <task id="7.1"><![CDATA[Document delegate input/output contracts and file handling.]]></task>
        <task id="7.2"><![CDATA[Map error handling for missing tools and failed conversions.]]></task>
        <task id="7.3"><![CDATA[Add integration tests for ABC and LilyPond delegates.]]></task>
      </tasks>
      <verification>
        <tests>
          <test type="integration">
            <file>t/118_tab.t</file>
            <description>Delegate integration baseline.</description>
            <assertions>Delegates produce renderable output or clear errors.</assertions>
          </test>
        </tests>
      </verification>
    </item>

    <item id="8" type="refactoring" status="PENDING" priority="LOW" complexity="M" ref-feature="CF-9">
      <title>[REF] Wx GUI workflow mapping</title>
      <justification><![CDATA[
GUI workflows and state transitions are not fully documented, and automated tests are
uncertain. Mapping reduces regression risk for UI changes.
]]></justification>
      <depends-on></depends-on>
      <tasks>
        <task id="8.1"><![CDATA[Document main GUI workflows: open, edit, preview, print.]]></task>
        <task id="8.2"><![CDATA[Map configuration and output settings used by the GUI.]]></task>
        <task id="8.3"><![CDATA[Create a manual test checklist for GUI regression.]]></task>
      </tasks>
      <verification>
        <tests>
          <test type="human">
            <file></file>
            <description>Manual GUI regression checklist run.</description>
            <assertions>GUI workflows complete without errors and outputs match CLI behavior.</assertions>
          </test>
        </tests>
      </verification>
    </item>

    <item id="9" type="refactoring" status="PENDING" priority="HIGH" complexity="M" ref-feature="CF-10">
      <title>[REF] Configuration system mapping</title>
      <justification><![CDATA[
Config precedence, restricted hashes, and overrides affect most features. The behavior is not
fully documented and lacks dedicated tests.
]]></justification>
      <depends-on></depends-on>
      <tasks>
        <task id="9.1"><![CDATA[Document config layering and precedence rules.]]></task>
        <task id="9.2"><![CDATA[Map restricted hash behavior and error cases.]]></task>
        <task id="9.3"><![CDATA[Add tests for override merging and invalid key handling.]]></task>
      </tasks>
      <verification>
        <tests>
          <test type="unit">
            <file>t/15_subst.t</file>
            <description>Config substitution and override tests.</description>
            <assertions>Overrides apply in correct order and errors are surfaced clearly.</assertions>
          </test>
        </tests>
      </verification>
    </item>

    <item id="17" type="bug" status="IN_PROGRESS" priority="HIGH" complexity="M" ref-feature="CF-7">
      <title>HTML5 chord diagram SVGs expand to full width</title>
      <justification><![CDATA[
In HTML5 paged output, chord diagram SVGs render at full column width instead of the
expected compact size (around 2-3em). The SVGs should have a fixed max width or be
controllable via CSS so diagram size remains consistent and readable in song layouts.
]]></justification>
      <depends-on></depends-on>
      <branch>bug/item-17-html5-chord-diagram-svgs-width</branch>
      <tasks>
        <task id="17.1"><![CDATA[Reproduce the full-width diagram rendering in HTML5 paged output and capture the generated HTML/CSS.]]></task>
        <task id="17.2"><![CDATA[Identify the CSS or template rule responsible for svg sizing in html5 chord diagrams.]]></task>
        <task id="17.3"><![CDATA[Constrain diagram SVG sizing (e.g., max-width in em) or add a configurable CSS variable override.]]></task>
        <task id="17.4"><![CDATA[Add regression coverage for diagram sizing in HTML5 paged output.]]></task>
      </tasks>
      <verification>
        <tests>
          <test type="unit">
            <file>t/86_html5_diagram_pos.t</file>
            <description>HTML5 chord diagram sizing.</description>
            <assertions>SVG diagrams respect the configured max width and do not expand to full column width.</assertions>
          </test>
        </tests>
      </verification>
      <r>
        <outcome>PROBLEM</outcome>
        <observations>Added a CSS diagram width variable and included chord diagram styles in the paged CSS template; updated t/86_html5_diagram_pos.t to assert diagram sizing, but the extended test run was interrupted (exit 130) before completion.</observations>
        <lessons-learned>Paged HTML5 output needs explicit inclusion of shared CSS templates to avoid missing sizing rules.</lessons-learned>
        <files>
          <file>lib/ChordPro/res/templates/html5/css/variables.tt</file>
          <file>lib/ChordPro/res/templates/html5/css/chord-diagrams.tt</file>
          <file>lib/ChordPro/res/templates/html5/paged/css/base.tt</file>
          <file>t/86_html5_diagram_pos.t</file>
          <file>ai-docs/overview-features-bugs.xml</file>
        </files>
      </r>
    </item>

    <item id="18" type="bug" status="IN_PROGRESS" priority="HIGH" complexity="S" ref-feature="CF-4">
      <title>HTML5 chord-only pairs align with lyrics instead of chord line</title>
      <justification><![CDATA[
When a chord-lyric pair has an empty lyric span (chord-only, e.g., trailing [Am] [Em] at the
end of a line), the HTML5 output aligns the chord with the lyric baseline instead of the
chord line. This misalignment makes chord-only entries drop to the lyric line and disrupts
the chord row alignment.
]]></justification>
      <depends-on></depends-on>
      <branch>bug/item-18-html5-chord-only-align-lyrics</branch>
      <tasks>
        <task id="18.1"><![CDATA[Reproduce chord-only alignment behavior in HTML5 output and capture the HTML/CSS for cp-chord-lyric-pair cp-chord-only.]]></task>
        <task id="18.2"><![CDATA[Identify the CSS/layout rule that aligns chord-only pairs to the lyric baseline instead of the chord line.]]></task>
        <task id="18.3"><![CDATA[Fix chord-only alignment so chords remain on the chord line (e.g., adjust display/vertical-align for cp-chord-only).]]></task>
        <task id="18.4"><![CDATA[Add regression coverage for chord-only alignment in HTML5 output.]]></task>
      </tasks>
      <verification>
        <tests>
          <test type="unit">
            <file>t/192_html5_chord_only_align.t</file>
            <description>HTML5 chord-only pair alignment.</description>
            <assertions>Chord-only pairs remain aligned with the chord line and do not drop to the lyric baseline.</assertions>
          </test>
        </tests>
      </verification>
      <r>
        <outcome>PROBLEM</outcome>
        <observations>Added flex-start alignment for chord-only pairs in HTML5 and paged CSS and created t/192_html5_chord_only_align.t; MANIFEST updated, but the extended test run was interrupted (exit 130) before completion.</observations>
        <lessons-learned>Chord-only alignment depends on consistent flex item alignment across both standard and paged CSS templates.</lessons-learned>
        <files>
          <file>lib/ChordPro/res/templates/html5/css/songlines.tt</file>
          <file>lib/ChordPro/res/templates/html5/paged/css/layout.tt</file>
          <file>t/192_html5_chord_only_align.t</file>
          <file>MANIFEST</file>
          <file>ai-docs/overview-features-bugs.xml</file>
        </files>
      </r>
    </item>

    <item id="19" type="feature" status="APPROVED" priority="MEDIUM" complexity="M" ref-feature="CF-4">
      <title>HTML5 configurable song page breaks</title>
      <justification><![CDATA[
HTML5 paged output needs a configurable way to force page breaks before or after each song
so users can control song separation in print layouts without manual CSS edits.
]]></justification>
      <depends-on></depends-on>
      <branch>feature/item-19-html5-configurable-song-page-breaks</branch>
      <tasks>
        <task id="19.1"><![CDATA[Define HTML5 config keys for song page breaks (before/after/both/none) and update config schema/defaults.]]></task>
        <task id="19.2"><![CDATA[Apply the config in the HTML5 song wrapper (paged output) with CSS classes or inline styles.]]></task>
        <task id="19.3"><![CDATA[Add or update documentation for the new HTML5 page break setting.]]></task>
        <task id="19.4"><![CDATA[Add regression tests for page-break before/after song rendering in HTML5 paged output.]]></task>
      </tasks>
      <verification>
        <tests>
          <test type="unit">
            <file>t/94_html5_page_breaks.t</file>
            <description>HTML5 song page-break configuration.</description>
            <assertions>Configured before/after page-breaks appear on the song container in paged output.</assertions>
          </test>
        </tests>
      </verification>
      <r>
        <outcome>PROBLEM</outcome>
        <observations>Actual combination of styles does not work.</observations>
        <lessons-learned>Dedicated break elements are more reliable than relying solely on break-before on the song wrapper.</lessons-learned>
        <files>
          <file>lib/ChordPro/res/config/chordpro.json</file>
          <file>lib/ChordPro/Output/HTML5.pm</file>
          <file>lib/ChordPro/res/templates/html5/song.tt</file>
          <file>lib/ChordPro/res/templates/html5/paged/song.tt</file>
          <file>lib/ChordPro/res/templates/html5/paged/css/layout.tt</file>
          <file>lib/ChordPro/res/config/config.schema</file>
          <file>docs/content/ChordPro-Configuration-HTML5.md</file>
          <file>t/94_html5_page_breaks.t</file>
          <file>MANIFEST</file>
          <file>ai-docs/overview-features-bugs.xml</file>
        </files>
      </r>
    </item>

    <item id="21" type="bug" status="APPROVED" priority="HIGH" complexity="M" ref-feature="CF-4">
      <title>HTML5 paged output lacks right/left/recto/verso break targets</title>
      <justification><![CDATA[
Paged.js supports break-before/break-after with right/left/recto/verso targets and
documents :blank page selectors for forced blank pages. HTML5 paged output only exposes
page-level breaks (before/after) and provides no way to request facing-page starts or
blank-page styling, preventing print layouts that require recto/verso alignment.
]]></justification>
      <depends-on></depends-on>
      <tasks>
        <task id="21.1"><![CDATA[Extend HTML5 paged break configuration to accept right/left/recto/verso targets for song and newpage breaks.]]></task>
        <task id="21.2"><![CDATA[Apply target-aware break-before/break-after rules in paged CSS and HTML output.]]></task>
        <task id="21.3"><![CDATA[Add :blank page styling hooks (e.g., suppress header/footer content) for forced blank pages.]]></task>
        <task id="21.4"><![CDATA[Add regression tests that confirm recto/verso breaks insert blank pages and :blank styles apply.]]></task>
      </tasks>
      <verification>
        <tests>
          <test type="unit">
            <file>t/96_html5_paged_recto_verso_breaks.t</file>
            <description>HTML5 paged recto/verso break targets.</description>
            <assertions>Configured right/left/recto/verso breaks force page starts and apply blank-page styling as expected.</assertions>
          </test>
        </tests>
      </verification>
      <r>
        <outcome>PROBLEM</outcome>
        <observations>Actual solution is not working; check for working examples in testing/aurorae/paged-js/layout-pagedjs.css`</observations>
        <files>
          <file>lib/ChordPro/Output/HTML5.pm</file>
          <file>lib/ChordPro/res/templates/html5/paged/css/layout.tt</file>
          <file>lib/ChordPro/res/templates/html5/paged/css/page-setup.tt</file>
          <file>lib/ChordPro/res/config/chordpro.json</file>
          <file>lib/ChordPro/res/config/config.schema</file>
          <file>t/96_html5_paged_recto_verso_breaks.t</file>
        </files>
      </r>
    </item>

    <item id="23" type="bug" status="APPROVED" priority="HIGH" complexity="M" ref-feature="CF-4">
      <title>HTML5 paged ToC page numbers do not follow paged.js target-counter pattern</title>
      <justification><![CDATA[
The HTML5 paged table of contents shows page numbers, but paged.js documentation specifies
that page numbers should be generated via target-counter(attr(href), page) on TOC links.
If the current implementation uses static values or non-target-counter markup, the page
numbers can be wrong after pagination or layout changes.
]]></justification>
      <depends-on></depends-on>
      <tasks>
        <task id="23.1"><![CDATA[Audit HTML5 paged TOC template/CSS to see how page numbers are generated and confirm whether target-counter is used.]]></task>
        <task id="23.2"><![CDATA[Align TOC page-number rendering with paged.js guidance using target-counter(attr(href), page).]]></task>
        <task id="23.3"><![CDATA[Add regression coverage ensuring TOC links render page numbers via target-counter in paged output.]]></task>
      </tasks>
      <verification>
        <tests>
          <test type="unit">
            <file>t/98_html5_paged_toc_page_numbers.t</file>
            <description>HTML5 paged TOC page-number rendering.</description>
            <assertions>TOC page numbers are generated with target-counter(attr(href), page) and update with pagination.</assertions>
          </test>
        </tests>
      </verification>
      <r>
        <outcome>PROBLEM</outcome>
        <observations>No Pagenumbers are generated with target-counter(attr(href), page). Look at `testing/experiments/createTocÂ´ for example implementation. </observations>
        <files>
          <file>lib/ChordPro/res/templates/html5/paged/toc.tt</file>
          <file>lib/ChordPro/res/templates/html5/paged/css/layout.tt</file>
          <file>lib/ChordPro/res/templates/html5/paged/songbook.tt</file>
          <file>t/78_html5_toc.t</file>
          <file>t/98_html5_paged_toc_page_numbers.t</file>
        </files>
      </r>
    </item>

  </items>

  <archive>
    <item id="11" type="bug" status="DONE" priority="HIGH" complexity="S" ref-feature="CF-4" archived="2026-02-09">
      <title>HTML5 image alignment regression in t/85_html5_image_align.t</title>
      <justification><![CDATA[
t/85_html5_image_align.t fails subtest 5, indicating a regression in HTML5 image alignment
rendering. This breaks expected HTML5 output formatting.
]]></justification>
      <depends-on></depends-on>
      <branch>bug/item-11-html5-image-alignment-regression</branch>
      <tasks>
        <task id="11.1"><![CDATA[Reproduce t/85_html5_image_align.t subtest 5 failure and capture actual vs expected HTML.]]></task>
        <task id="11.2"><![CDATA[Identify the HTML5 image alignment path (template/CSS/rendering) responsible for the mismatch.]]></task>
        <task id="11.3"><![CDATA[Fix HTML5 image alignment output and add/update regression coverage.]]></task>
      </tasks>
      <verification>
        <tests>
          <test type="unit">
            <file>t/85_html5_image_align.t</file>
            <description>HTML5 image alignment regression test.</description>
            <assertions>Subtest 5 passes and generated HTML matches expected alignment output.</assertions>
          </test>
        </tests>
      </verification>
      <r>
        <outcome>DONE</outcome>
        <observations>Image scaling now preserves explicit width/height attributes when scale is set, which restores the expected HTML5 output.</observations>
        <lessons-learned>Scale handling should not override explicit dimensions when the caller supplies width or height.</lessons-learned>
        <files>
          <file>lib/ChordPro/Output/HTML5.pm</file>
          <file>ai-docs/overview-features-bugs.xml</file>
        </files>
      </r>
    </item>
    <item id="12" type="refactoring" status="DONE" priority="MEDIUM" complexity="S" ref-feature="CF-4" archived="2026-02-09">
      <title>[REF] HTML5 image scale behavior alignment</title>
      <justification><![CDATA[
HTML5 image scaling logic and tests diverge on whether scale should override explicit
width/height or only apply when dimensions are omitted. Clarifying and aligning behavior
prevents regressions across HTML5 image tests.
]]></justification>
      <depends-on></depends-on>
      <branch>refactoring/item-12-html5-image-scale-behavior-alignment</branch>
      <tasks>
        <task id="12.1"><![CDATA[Define the intended behavior for width/height combined with scale in HTML5 image rendering.]]></task>
        <task id="12.2"><![CDATA[Update HTML5 image scaling logic to match the intended behavior.]]></task>
        <task id="12.3"><![CDATA[Align HTML5 image scale tests with the updated behavior expectations.]]></task>
      </tasks>
      <verification>
        <tests>
          <test type="unit">
            <file>t/85_html5_image_align.t</file>
            <description>Scale plus explicit width alignment behavior.</description>
            <assertions>Width and scale interactions match the documented behavior.</assertions>
          </test>
          <test type="unit">
            <file>t/190_html5_bug7_image_scale_pagewidth.t</file>
            <description>Scale-only and width+scale behavior.</description>
            <assertions>Scale handling matches expected HTML output for both cases.</assertions>
          </test>
          <test type="unit">
            <file>t/191_html5_image_scale.t</file>
            <description>HTML5 image scale regression coverage.</description>
            <assertions>Scale behavior remains consistent across HTML5 images.</assertions>
          </test>
        </tests>
      </verification>
      <r>
        <outcome>DONE</outcome>
        <observations>HTML5 image scaling now treats scale-only inputs as percentage widths, while width+scale remains a multiplier; the page-width test now exercises scale-only behavior.</observations>
        <lessons-learned>Scale input parsing normalizes percentages to numeric factors, so tests must focus on observable output rather than input syntax.</lessons-learned>
        <files>
          <file>lib/ChordPro/Output/HTML5.pm</file>
          <file>t/190_html5_bug7_image_scale_pagewidth.t</file>
          <file>ai-docs/overview-features-bugs.xml</file>
        </files>
      </r>
    </item>
    <item id="10" type="refactoring" status="DONE" priority="MEDIUM" complexity="M" ref-feature="CF-11" archived="2026-02-10">
      <title>[REF] Documentation coverage mapping</title>
      <justification><![CDATA[
Docs site covers core usage but advanced configuration and backend-specific behavior are
incomplete. Mapping gaps helps prioritize documentation work.
]]></justification>
      <depends-on></depends-on>
      <tasks>
        <task id="10.1"><![CDATA[Audit docs coverage against existing features and config keys.]]></task>
        <task id="10.2"><![CDATA[Document backend selection and HTML5 print configuration.]]></task>
        <task id="10.3"><![CDATA[Build docs site and verify new content renders.]]></task>
      </tasks>
      <verification>
        <tests>
          <test type="human">
            <file>docs/</file>
            <description>Build docs site with Hugo and review output.</description>
            <assertions>New sections render correctly and navigation is updated.</assertions>
          </test>
        </tests>
      </verification>
      <r>
        <outcome>DONE</outcome>
        <observations>Added backend selection and HTML5 print-mode guidance to configuration overview and HTML5 configuration docs, and the docs build now completes successfully.</observations>
        <lessons-learned>Broken relrefs surface at docs build time; verify links during content updates.</lessons-learned>
        <files>
          <file>docs/content/ChordPro-Configuration-Overview.md</file>
          <file>docs/content/ChordPro-Configuration-HTML5.md</file>
          <file>ai-docs/overview-features-bugs.xml</file>
        </files>
      </r>
    </item>
    <item id="13" type="bug" status="DONE" priority="HIGH" complexity="S" ref-feature="CF-4" archived="2026-02-10">
      <title>HTML5 format config access uses redundant eval fallbacks</title>
      <justification><![CDATA[
Default configuration is always loaded first, so HTML5 format entries should exist in the
config tree. Redundant eval-based fallbacks (e.g., eval { $config->{html5} } // {}) can mask
config errors and blur the intended handling of restricted hashes. The HTML5 format generator
should rely on the default config guarantees and only use eval where restricted hashes require
safe access.
]]></justification>
      <depends-on></depends-on>
      <branch>bug/item-13-html5-format-config-access-uses-redundant-eval-fallbacks</branch>
      <tasks>
        <task id="13.1"><![CDATA[Confirm default config guarantees for html5/pdf format keys and how restricted hashes are accessed safely.]]></task>
        <task id="13.2"><![CDATA[Remove redundant eval fallbacks in HTML5 format generation and related config access paths.]]></task>
        <task id="13.3"><![CDATA[Add or update tests/docs to cover HTML5 format generation with default config and restricted hashes.]]></task>
      </tasks>
      <verification>
        <tests>
          <test type="unit">
            <file>t/190_html5_bugfixes.t</file>
            <description>HTML5 format generator with default config.</description>
            <assertions>Format rules are generated without eval fallbacks and remain correct with restricted hashes.</assertions>
          </test>
        </tests>
      </verification>
      <r>
        <outcome>DONE</outcome>
        <observations>Removed eval fallbacks for HTML5 config paths guaranteed by defaults, while keeping guarded access for optional or overridden format keys (including cases where pdf.formats omits default/title/first) and for custom CSS/paged overrides.</observations>
        <lessons-learned>Restricted hashes raise on disallowed keys, so optional or overwritten config keys still require guarded access even when defaults are always loaded.</lessons-learned>
        <files>
          <file>lib/ChordPro/Output/HTML5.pm</file>
          <file>lib/ChordPro/Output/HTML5Helper/FormatGenerator.pm</file>
          <file>ai-docs/overview-features-bugs.xml</file>
        </files>
      </r>
    </item>
    <item id="14" type="refactoring" status="DONE" priority="MEDIUM" complexity="S" ref-feature="CF-4" archived="2026-02-10">
      <title>Make HTML5 print mode the default config value</title>
      <justification><![CDATA[
HTML5 output is now commonly used for paged/print workflows. Setting html5.mode default to
"print" aligns the default configuration with the desired output mode and reduces the need
for per-project overrides. This change should update the default config and its generated
Config::Data snapshot, plus any docs or tests that assume "responsive" as the default.
]]></justification>
      <depends-on></depends-on>
      <branch>refactoring/item-14-make-html5-print-mode-default</branch>
      <tasks>
        <task id="14.1"><![CDATA[Update the default html5.mode value in lib/ChordPro/res/config/chordpro.json to "print".]]></task>
        <task id="14.2"><![CDATA[Regenerate lib/ChordPro/Config/Data.pm via script/cfgboot.pl or the standard build step.]]></task>
        <task id="14.3"><![CDATA[Update docs/tests that assume "responsive" is the default HTML5 mode.]]></task>
      </tasks>
      <verification>
        <tests>
          <test type="unit">
            <file>t/79_html5_oddeven.t</file>
            <description>HTML5 paged mode CSS generation.</description>
            <assertions>Default config uses print mode and paged CSS rules are generated as expected.</assertions>
          </test>
        </tests>
      </verification>
      <r>
        <outcome>DONE</outcome>
        <observations>Default HTML5 mode now uses print/paged output, and the generated Config::Data snapshot reflects the new default.</observations>
        <lessons-learned>Regenerating Config::Data.pm also refreshes Config.pod, so documentation artifacts must be tracked alongside config changes.</lessons-learned>
        <files>
          <file>lib/ChordPro/res/config/chordpro.json</file>
          <file>lib/ChordPro/Config/Data.pm</file>
          <file>lib/ChordPro/res/pod/Config.pod</file>
          <file>ai-docs/overview-features-bugs.xml</file>
        </files>
      </r>
    </item>
    <item id="15" type="refactoring" status="DONE" priority="MEDIUM" complexity="M" ref-feature="CF-11" archived="2026-02-10">
      <title>Update HTML5 configuration docs with full config feature set and examples</title>
      <justification><![CDATA[
The HTML5 configuration guide needs a complete, current inventory of supported settings and
examples so users can configure templates, paged output, CSS customization, and PDF
compatibility without relying on defaults or source code. Updating the documentation reduces
configuration errors and aligns with recent HTML5 backend changes.
]]></justification>
      <depends-on></depends-on>
      <branch>refactoring/item-15-update-html5-configuration-docs</branch>
      <tasks>
        <task id="15.1"><![CDATA[Audit HTML5 configuration keys against lib/ChordPro/res/config/chordpro.json and HTML5 backend usage.]]></task>
        <task id="15.2"><![CDATA[Update docs/content/ChordPro-Configuration-HTML5.md with a complete config feature list and examples.]]></task>
        <task id="15.3"><![CDATA[Call out default behaviors and inheritance rules (html5, html5.paged, pdf fallbacks).]]></task>
      </tasks>
      <verification>
        <tests>
          <test type="human">
            <file>docs/content/ChordPro-Configuration-HTML5.md</file>
            <description>Documentation review for HTML5 configuration completeness.</description>
            <assertions>All supported HTML5 config keys are listed with at least one example per section.</assertions>
          </test>
        </tests>
      </verification>
      <r>
        <outcome>DONE</outcome>
        <observations>Added a configuration reference section with full HTML5 key coverage, updated the default mode description, and documented paged overrides and PDF fallbacks.</observations>
        <lessons-learned>Keeping a short reference block near the top makes it easier to reconcile docs with evolving config defaults.</lessons-learned>
        <files>
          <file>docs/content/ChordPro-Configuration-HTML5.md</file>
          <file>ai-docs/overview-features-bugs.xml</file>
        </files>
      </r>
    </item>
    <item id="16" type="bug" status="DONE" priority="HIGH" complexity="M" ref-feature="CF-4" archived="2026-02-10">
      <title>HTML5 config rejects paged margins and css fonts in user config</title>
      <justification><![CDATA[
Running HTML5 output with a user config fails with "unknown item" errors for
html5.paged.papersize/margins and html5.css.fonts.text, indicating the config schema or
override handling is rejecting valid HTML5 settings. This blocks practical HTML5 print
configuration despite defaults supporting these keys.
]]></justification>
      <depends-on></depends-on>
      <branch>bug/item-16-html5-config-rejects-paged-margins-css-fonts</branch>
      <tasks>
        <task id="16.1"><![CDATA[Reproduce the config errors with the provided command and config file.]]></task>
        <task id="16.2"><![CDATA[Identify why html5.paged.* and html5.css.fonts.* are rejected (schema, merge, or validation path).]]></task>
        <task id="16.3"><![CDATA[Fix config validation/merge so HTML5 paged margins and css fonts are accepted in user configs.]]></task>
        <task id="16.4"><![CDATA[Add regression coverage for html5.paged margins and html5.css.fonts in config overrides.]]></task>
      </tasks>
      <verification>
        <tests>
          <test type="unit">
            <file>t/210_configs.t</file>
            <description>HTML5 config override acceptance.</description>
            <assertions>html5.paged margins and html5.css.fonts overrides load without unknown-item errors.</assertions>
          </test>
        </tests>
      </verification>
      <r>
        <outcome>DONE</outcome>
        <observations>HTML5 override keys now load without unknown-item errors, and paged margin defaults are represented in the base config.</observations>
        <lessons-learned>Allowing free-form CSS override maps requires explicit relaxations in config validation while keeping other keys strict.</lessons-learned>
        <files>
          <file>lib/ChordPro/Config.pm</file>
          <file>lib/ChordPro/res/config/chordpro.json</file>
          <file>lib/ChordPro/Config/Data.pm</file>
          <file>lib/ChordPro/res/pod/Config.pod</file>
          <file>t/210_configs.t</file>
          <file>ai-docs/overview-features-bugs.xml</file>
        </files>
      </r>
    </item>
    <item id="20" type="bug" status="DONE" priority="HIGH" complexity="M" ref-feature="CF-4" archived="2026-02-10">
      <title>HTML5 paged newpage uses legacy page-break-only CSS</title>
      <justification><![CDATA[
HTML5 newpage directives currently emit inline page-break-only styles, and several paged
CSS rules still rely on page-break-* without equivalent break-* properties. Paged.js
documentation emphasizes break-before/break-after for pagination, so page-break-only rules
can be ignored or handled inconsistently, matching reports that page breaks do not apply.
]]></justification>
      <depends-on></depends-on>
      <branch>refactoring/item-24-refactor-html5-paged-stylesheet-sections</branch>
      <tasks>
        <task id="20.1"><![CDATA[Audit HTML5 paged CSS and newpage/new_physical_page handlers for page-break-only usage that lacks break-before/break-after equivalents.]]></task>
        <task id="20.2"><![CDATA[Emit break-before/break-after in paged output (retain page-break-* for non-paged fallback compatibility).]]></task>
        <task id="20.3"><![CDATA[Add regression coverage for paged newpage directives verifying break-before/break-after is present in generated HTML/CSS.]]></task>
      </tasks>
      <verification>
        <tests>
          <test type="unit">
            <file>t/95_html5_paged_newpage.t</file>
            <description>HTML5 paged newpage break behavior.</description>
            <assertions>Newpage directives produce break-before/break-after rules in paged output and result in visible page breaks.</assertions>
          </test>
        </tests>
      </verification>
      <r>
        <outcome>DONE</outcome>
        <observations>Newpage directives now emit paged break classes and CSS rules use break-before/break-after with page-break fallbacks.</observations>
        <lessons-learned>Keeping legacy page-break fallbacks helps preserve behavior in non-paged renderers.</lessons-learned>
        <files>
          <file>lib/ChordPro/Output/HTML5.pm</file>
          <file>lib/ChordPro/res/templates/html5/paged/css/layout.tt</file>
          <file>t/95_html5_paged_newpage.t</file>
        </files>
      </r>
    </item>
    <item id="22" type="bug" status="DONE" priority="HIGH" complexity="M" ref-feature="CF-4" archived="2026-02-10">
      <title>HTML5 paged cover/front/back matter omit named page rules</title>
      <justification><![CDATA[
Paged.js supports named pages via the CSS page property and matching @page rules, allowing
front-matter, back-matter, and cover sections to use distinct layouts. The HTML5 paged
templates do not apply named page assignments for these sections, so they cannot have
dedicated page layouts (margins, headers/footers, backgrounds), limiting print control.
]]></justification>
      <depends-on></depends-on>
      <tasks>
        <task id="22.1"><![CDATA[Audit HTML5 paged templates/CSS for cover, front-matter, and back-matter sections and confirm missing named page assignments.]]></task>
        <task id="22.2"><![CDATA[Add named page assignments (page: cover/frontmatter/backmatter) to the relevant HTML5 paged wrappers.]]></task>
        <task id="22.3"><![CDATA[Define @page named rules and defaults for these sections (including left/right variants where applicable).]]></task>
        <task id="22.4"><![CDATA[Add regression tests to confirm named page rules are emitted and applied to cover/front/back matter in paged output.]]></task>
      </tasks>
      <verification>
        <tests>
          <test type="unit">
            <file>t/97_html5_paged_named_pages_matter.t</file>
            <description>HTML5 paged named pages for cover/front/back matter.</description>
            <assertions>Cover/front-matter/back-matter sections emit page: named-page rules and match @page definitions in paged CSS.</assertions>
          </test>
        </tests>
      </verification>
      <r>
        <outcome>DONE</outcome>
        <observations>Cover/front/back matter wrappers now assign named pages that map to @page rules.</observations>
        <lessons-learned>Named pages are easiest to validate with both CSS and HTML wrapper tests.</lessons-learned>
        <files>
          <file>lib/ChordPro/res/templates/html5/paged/css/layout.tt</file>
          <file>lib/ChordPro/res/templates/html5/paged/css/page-setup.tt</file>
          <file>t/97_html5_paged_named_pages_matter.t</file>
        </files>
      </r>
    </item>
    <item id="24" type="refactoring" status="DONE" priority="MEDIUM" complexity="M" ref-feature="CF-4" archived="2026-02-10">
      <title>[REF] Refactor HTML5 paged stylesheet to use section-based layout rules</title>
      <justification><![CDATA[
The current paged stylesheet is oversized and does not consistently apply section-based
layout rules, making it harder to maintain and align with real-world paged.js usage.
The Aurorae sample (testing/aurorae/style-book.css and paged-js/*.css) and the experiments
directory provide working patterns that should inform a slimmer, section-oriented CSS
layout, especially in the context of REF items 19-21 and the paged.js analytics notes.
]]></justification>
      <depends-on></depends-on>
      <branch>refactoring/item-24-refactor-html5-paged-stylesheet-sections</branch>
      <tasks>
        <task id="24.1"><![CDATA[Audit HTML5 paged CSS selectors and identify rules that should target section wrappers (cover/frontmatter/chapters/appendices).]]></task>
        <task id="24.2"><![CDATA[Refactor the paged CSS to consolidate redundant rules and align section-based layout with Aurorae/experiments examples.]]></task>
        <task id="24.3"><![CDATA[Update HTML5 songbook part tests to accept section-based wrappers (t/80_html5_songbook_parts.t, t/97_html5_paged_named_pages_matter.t).]]></task>
        <task id="24.4"><![CDATA[Review diagram position expectations under the new paged CSS includes and adjust t/86_html5_diagram_pos.t if needed.]]></task>
        <task id="24.5"><![CDATA[Document the new section-based CSS patterns and note any required HTML wrapper changes.]]></task>
      </tasks>
      <verification>
        <tests>
          <test type="unit">
            <file>t/80_html5_songbook_parts.t</file>
            <description>HTML5 songbook parts wrappers.</description>
            <assertions>Cover/front/back matter wrappers are detected with section-based markup.</assertions>
          </test>
          <test type="unit">
            <file>t/86_html5_diagram_pos.t</file>
            <description>HTML5 diagram positioning with paged CSS refactor.</description>
            <assertions>Diagram placement expectations match the updated paged CSS composition.</assertions>
          </test>
          <test type="unit">
            <file>t/97_html5_paged_named_pages_matter.t</file>
            <description>HTML5 paged named pages with section wrappers.</description>
            <assertions>Named page wrappers are detected with section-based markup.</assertions>
          </test>
          <test type="unit">
            <file>t/99_html5_paged_stylesheet_sections.t</file>
            <description>HTML5 paged stylesheet section selector coverage.</description>
            <assertions>Paged CSS emits section-based rules for cover/frontmatter/body/appendix and avoids redundant selectors.</assertions>
          </test>
        </tests>
      </verification>
      <r>
        <outcome>DONE</outcome>
        <observations>Updated HTML5 paged tests to accept section-based wrappers and more flexible class ordering; diagram placement checks now handle section wrappers. Full test suite passes.</observations>
        <lessons-learned>Use class word-boundary matches and wrapper-agnostic selectors in tests when HTML output may vary by tag or attribute order.</lessons-learned>
        <files>
          <file>lib/ChordPro/Output/HTML5.pm</file>
          <file>lib/ChordPro/res/templates/html5/paged/song.tt</file>
          <file>lib/ChordPro/res/templates/html5/paged/toc.tt</file>
          <file>lib/ChordPro/res/templates/html5/paged/css/base.tt</file>
          <file>lib/ChordPro/res/templates/html5/paged/css/layout.tt</file>
          <file>ai-docs/pagedjs-analytics-and-usage.md</file>
          <file>t/80_html5_songbook_parts.t</file>
          <file>t/86_html5_diagram_pos.t</file>
          <file>t/97_html5_paged_named_pages_matter.t</file>
          <file>t/99_html5_paged_stylesheet_sections.t</file>
          <file>ai-docs/overview-features-bugs.xml</file>
        </files>
      </r>
    </item>
  </archive>

  <changelog>
    <entry date="2026-02-08">Initial code analysis; generated overview.xml and created 10 [REF] items.</entry>
    <entry date="2026-02-08">Added bug item for HTML5 image alignment regression (t/85_html5_image_align.t).</entry>
    <entry date="2026-02-08">Item 11 implemented. HTML5 image scaling preserves explicit width/height when scale is provided.</entry>
    <entry date="2026-02-08">Added refactoring item to align HTML5 image scale behavior and tests.</entry>
    <entry date="2026-02-08">Item 12 implemented. Aligned HTML5 image scaling logic and tests for scale-only vs width+scale behavior.</entry>
    <entry date="2026-02-09">Archived items 11 and 12.</entry>
    <entry date="2026-02-09">Added bug item for HTML5 format config access and redundant eval fallbacks.</entry>
    <entry date="2026-02-09">Item 13 implemented. Reduced redundant eval access in HTML5 format configuration paths.</entry>
    <entry date="2026-02-09">Added refactoring item to change default HTML5 mode to print.</entry>
    <entry date="2026-02-09">Added refactoring item to update HTML5 configuration documentation.</entry>
    <entry date="2026-02-09">Approved items 14 and 15.</entry>
    <entry date="2026-02-09">Items 14 and 15 implemented. Defaulted HTML5 mode to print and expanded HTML5 configuration documentation.</entry>
    <entry date="2026-02-09">Added bug item for HTML5 config override validation errors in paged margins and CSS fonts.</entry>
    <entry date="2026-02-09">Item 16 implemented. Allowed HTML5 paged margin and CSS font overrides in user config.</entry>
    <entry date="2026-02-09">Added bug item for HTML5 chord diagram SVG sizing in paged output.</entry>
    <entry date="2026-02-09">Added bug item for HTML5 chord-only alignment dropping to lyric baseline.</entry>
    <entry date="2026-02-09">Approved items 17 and 18.</entry>
    <entry date="2026-02-10">Items 20-23 implemented. Added paged break classes with right/left/recto/verso targets, blank-page margin suppression, named pages for cover/front/back matter, target-counter TOC page numbers, config/schema updates, and tests.</entry>
    <entry date="2026-02-10">Item 19 verified. Added explicit song break elements for paged mode and aligned documentation with paged break targets and newpage settings.</entry>
    <entry date="2026-02-09">Items 17 and 18 implemented. Added diagram sizing variable with paged CSS include and aligned chord-only pairs; added tests, but extended test run was interrupted.</entry>
    <entry date="2026-02-09">Added feature item for configurable HTML5 page breaks before/after songs.</entry>
    <entry date="2026-02-09">Item 19 implemented. Added configurable HTML5 paged song page breaks with template classes, CSS rules, docs, and tests; xt/01_config.t failed due to missing chordpro.prp.</entry>
    <entry date="2026-02-10">Added bug item for HTML5 paged newpage break handling using break-before/break-after.</entry>
    <entry date="2026-02-10">Added bug item for HTML5 paged right/left/recto/verso break targets and blank-page styling.</entry>
    <entry date="2026-02-10">Added bug item for HTML5 paged named page rules on cover/front/back matter.</entry>
    <entry date="2026-02-10">Added bug item for HTML5 paged table-of-contents page numbers using target-counter.</entry>
    <entry date="2026-02-10">Added refactoring item for section-based HTML5 paged stylesheet cleanup informed by Aurorae/experiments samples.</entry>
    <entry date="2026-02-10">Item 24 in progress. Added section-based wrappers/selectors for paged HTML5 output and refactored paged CSS to reuse shared templates; full test suite interrupted.</entry>
    <entry date="2026-02-10">Item 24 implemented. Updated HTML5 paged tests for section wrappers and diagram placement; full test suite passes.</entry>
    <entry date="2026-02-10">Item 10 implemented. Documented backend selection and HTML5 print configuration; docs build passes after fixing the file format relref.</entry>
    <entry date="2026-02-10">Archived items 10, 13, 14, 15, 16, 20, 22, and 24.</entry>
  </changelog>
</implementation-plan>
