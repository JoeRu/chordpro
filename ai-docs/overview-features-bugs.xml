<?xml version="1.0" encoding="UTF-8"?>
<implementation-plan>
  <metadata>
    <title>ChordPro Feature and Bug Plan</title>
    <version>3.1</version>
    <date>2026-02-08</date>
    <updated>2026-02-11</updated>
    <status>Initial code analysis (2026-02-08)</status>
    <summary>
      Initial analysis of the ChordPro codebase. Established architecture, dependencies, and
      feature inventory. Created reference items for incomplete feature mapping and test
      coverage gaps.
    </summary>
  </metadata>

  <items>


    <item id="18" type="bug" status="IN_PROGRESS" priority="HIGH" complexity="S" ref-feature="CF-4">
      <title>HTML5 chord-only pairs align with lyrics instead of chord line</title>
      <justification><![CDATA[
When a chord-lyric pair has an empty lyric span (chord-only, e.g., trailing [Am] [Em] at the
end of a line), the HTML5 output aligns the chord with the lyric baseline instead of the
chord line. This misalignment makes chord-only entries drop to the lyric line and disrupts
the chord row alignment.
]]></justification>
      <depends-on></depends-on>
      <branch>bug/item-18-html5-chord-only-align-lyrics</branch>
      <tasks>
        <task id="18.1"><![CDATA[Reproduce chord-only alignment behavior in HTML5 output and capture the HTML/CSS for cp-chord-lyric-pair cp-chord-only.]]></task>
        <task id="18.2"><![CDATA[Identify the CSS/layout rule that aligns chord-only pairs to the lyric baseline instead of the chord line.]]></task>
        <task id="18.3"><![CDATA[Fix chord-only alignment so chords remain on the chord line (e.g., adjust display/vertical-align for cp-chord-only).]]></task>
        <task id="18.4"><![CDATA[Add regression coverage for chord-only alignment in HTML5 output.]]></task>
      </tasks>
      <verification>
        <tests>
          <test type="unit">
            <file>t/192_html5_chord_only_align.t</file>
            <description>HTML5 chord-only pair alignment.</description>
            <assertions>Chord-only pairs remain aligned with the chord line and do not drop to the lyric baseline.</assertions>
          </test>
        </tests>
      </verification>
      <r>
        <outcome>PROBLEM</outcome>
        <observations>Added flex-start alignment for chord-only pairs in HTML5 and paged CSS and created t/192_html5_chord_only_align.t; MANIFEST updated, but the extended test run was interrupted (exit 130) before completion.</observations>
        <lessons-learned>Chord-only alignment depends on consistent flex item alignment across both standard and paged CSS templates.</lessons-learned>
        <files>
          <file>lib/ChordPro/res/templates/html5/css/songlines.tt</file>
          <file>lib/ChordPro/res/templates/html5/paged/css/layout.tt</file>
          <file>t/192_html5_chord_only_align.t</file>
          <file>MANIFEST</file>
          <file>ai-docs/overview-features-bugs.xml</file>
        </files>
      </r>
    </item>

    <item id="19" type="feature" status="DONE" priority="MEDIUM" complexity="M" ref-feature="CF-4">
      <title>HTML5 configurable song page breaks</title>
      <justification><![CDATA[
HTML5 paged output needs a configurable way to force page breaks before or after each song
so users can control song separation in print layouts without manual CSS edits.
]]></justification>
      <depends-on></depends-on>
      <branch>feature/item-19-html5-configurable-song-page-breaks</branch>
      <tasks>
        <task id="19.1"><![CDATA[Define HTML5 config keys for song page breaks (before/after/both/none) and update config schema/defaults.]]></task>
        <task id="19.2"><![CDATA[Apply the config in the HTML5 song wrapper (paged output) with CSS classes or inline styles.]]></task>
        <task id="19.3"><![CDATA[Add or update documentation for the new HTML5 page break setting.]]></task>
        <task id="19.4"><![CDATA[Add regression tests for page-break before/after song rendering in HTML5 paged output.]]></task>
      </tasks>
      <verification>
        <tests>
          <test type="unit">
            <file>t/94_html5_page_breaks.t</file>
            <description>HTML5 song page-break configuration.</description>
            <assertions>Configured before/after page-breaks appear on the song container in paged output.</assertions>
          </test>
        </tests>
      </verification>
      <r>
        <outcome>DONE</outcome>
        <observations>Paged song breaks now insert dedicated break elements between songs and only apply after-break classes on song wrappers, with tests and docs updated accordingly.</observations>
        <lessons-learned>Dedicated break elements avoid leading blank pages and behave more consistently than relying on wrapper break-before.</lessons-learned>
        <files>
          <file>lib/ChordPro/Output/HTML5.pm</file>
          <file>docs/content/ChordPro-Configuration-HTML5.md</file>
          <file>t/94_html5_page_breaks.t</file>
          <file>ai-docs/overview-features-bugs.xml</file>
        </files>
      </r>
    </item>

    <item id="20" type="feature" status="DONE" priority="MEDIUM" complexity="L" ref-feature="CF-4">
      <title>HTML5 minimal paged output bundle with externalized CSS</title>
      <justification><![CDATA[
To validate item 19 page-break behavior with the smallest possible surface area, create an
absolute minimal HTML5 paged output test: no TOC, minimal stylesheets, and only a page-break
section. Templates should emit separate CSS files (split between page/structure/layout and
content such as fonts/images), and output should be a folder containing the HTML plus the
required CSS files.
]]></justification>
      <depends-on>19</depends-on>
      <branch>feature/item-20-html5-minimal-paged-bundle</branch>
      <tasks>
        <task id="20.1"><![CDATA[Define a minimal HTML5 paged template variant that renders only the page-break section (no TOC) for deterministic tests.]]></task>
        <task id="20.2"><![CDATA[Split HTML5 paged stylesheets into external CSS files, separating page/structure/layout from content (fonts, images) and update templates to link them.]]></task>
        <task id="20.3"><![CDATA[Update HTML5 output to emit a folder bundle (HTML file + referenced CSS assets) for the minimal paged variant.]]></task>
        <task id="20.4"><![CDATA[Add a minimal regression test that asserts the bundle structure, linked CSS files, and page-break section output.]]></task>
      </tasks>
      <verification>
        <tests>
          <test type="unit">
            <file>testing/95_html5_minimal_paged_bundle.t</file>
            <description>Minimal HTML5 paged bundle output with externalized CSS.</description>
            <assertions>Output creates a folder with HTML + CSS files, omits TOC, and includes the page-break section.</assertions>
          </test>
        </tests>
      </verification>
      <r>
        <outcome>DONE</outcome>
        <observations>Added a minimal paged bundle mode that writes a folder with HTML plus split layout/content CSS, and introduced a minimal paged songbook template that omits TOC. Implemented a focused regression test; running make refreshed Config/Data.pm and Config.pod after the config changes.</observations>
        <lessons-learned>Bundle output should be written directly by the backend to avoid the standard single-file output path.</lessons-learned>
        <files>
          <file>lib/ChordPro/Output/HTML5.pm</file>
          <file>lib/ChordPro/res/templates/html5/paged/songbook-minimal.tt</file>
          <file>lib/ChordPro/res/templates/html5/paged/css/layout-minimal.tt</file>
          <file>lib/ChordPro/res/templates/html5/paged/css/content-minimal.tt</file>
          <file>lib/ChordPro/res/config/chordpro.json</file>
          <file>lib/ChordPro/res/config/config.schema</file>
          <file>lib/ChordPro/Config/Data.pm</file>
          <file>lib/ChordPro/res/pod/Config.pod</file>
          <file>testing/95_html5_minimal_paged_bundle.t</file>
          <file>ai-docs/overview-features-bugs.xml</file>
        </files>
      </r>
    </item>

    <item id="21" type="bug" status="DONE" priority="HIGH" complexity="S" ref-feature="CF-4">
      <title>HTML5 output includes excessive empty lines</title>
      <justification><![CDATA[
HTML5 output currently emits many unnecessary blank lines, making the generated HTML harder
to diff, review, and post-process. The output should be condensed to avoid redundant empty
lines while preserving semantic formatting.
]]></justification>
      <depends-on></depends-on>
      <tasks>
        <task id="21.1"><![CDATA[Identify the HTML5 template/output paths that introduce redundant blank lines in generated HTML.]]></task>
        <task id="21.2"><![CDATA[Condense HTML5 output by trimming or normalizing repeated blank lines without changing semantic output.]]></task>
        <task id="21.3"><![CDATA[Add regression coverage that asserts HTML5 output does not contain runs of unnecessary empty lines.]]></task>
      </tasks>
      <verification>
        <tests>
          <test type="unit">
            <file>testing/96_html5_condense_output.t</file>
            <description>HTML5 output blank line normalization.</description>
            <assertions>Generated HTML does not contain redundant consecutive empty lines.</assertions>
          </test>
        </tests>
      </verification>
      <r>
        <outcome>DONE</outcome>
        <observations>HTML5 output now normalizes multiple blank lines and returns newline-free line arrays to avoid doubled spacing.</observations>
        <lessons-learned>Normalize HTML output before line splitting to prevent writer joins from reintroducing extra whitespace.</lessons-learned>
        <files>
          <file>lib/ChordPro/Output/HTML5.pm</file>
          <file>testing/96_html5_condense_output.t</file>
          <file>ai-docs/overview-features-bugs.xml</file>
        </files>
      </r>
    </item>

    <item id="22" type="refactoring" status="DONE" priority="MEDIUM" complexity="S" ref-feature="CF-4">
      <title>Remove gray background from HTML5 paged output</title>
      <justification><![CDATA[
HTML5 paged output currently applies a gray background in the screen preview styles.
Switch it to white or remove the background to simplify the default visual presentation.
]]></justification>
      <depends-on></depends-on>
      <tasks>
        <task id="22.1"><![CDATA[Identify where the HTML5 paged background color is set for screen output.]]></task>
        <task id="22.2"><![CDATA[Update the paged screen styles to use white or remove the background setting.]]></task>
        <task id="22.3"><![CDATA[Add regression coverage to confirm the paged screen background is no longer gray.]]></task>
      </tasks>
      <verification>
        <tests>
          <test type="unit">
            <file>testing/97_html5_paged_background.t</file>
            <description>HTML5 paged screen background color.</description>
            <assertions>Paged HTML5 screen styles no longer apply a gray background.</assertions>
          </test>
        </tests>
      </verification>
      <r>
        <outcome>DONE</outcome>
        <observations>Paged screen preview styles now use a white background and the regression test validates the change.</observations>
        <lessons-learned>Keeping preview styles aligned with print defaults avoids visual surprises.</lessons-learned>
        <files>
          <file>lib/ChordPro/res/templates/html5/paged/css/print-media.tt</file>
          <file>testing/97_html5_paged_background.t</file>
          <file>ai-docs/overview-features-bugs.xml</file>
        </files>
      </r>
    </item>

    <item id="23" type="refactoring" status="DONE" priority="MEDIUM" complexity="M" ref-feature="CF-4">
      <title>Consolidate HTML5 paged templates and external CSS split</title>
      <justification><![CDATA[
Minimal paged output now works, but the template set is fragmented. Refactor the paged
templates to use external stylesheets split into layout/content, merge templates where
possible to reduce complexity, remove obsolete files, and move minimal config templates to
testing. Remove the minimal template entry from config to keep the production configuration
lean.
]]></justification>
      <depends-on></depends-on>
      <tasks>
        <task id="23.1"><![CDATA[Merge paged templates to reduce duplication while keeping layout/content CSS split.]]></task>
        <task id="23.2"><![CDATA[Remove obsolete paged template files and update references accordingly.]]></task>
        <task id="23.3"><![CDATA[Move minimal config templates into the testing folder and remove minimal template entries from config.]]></task>
        <task id="23.4"><![CDATA[Add/update tests to confirm the refactored templates still produce correct paged output with external CSS.]]></task>
      </tasks>
      <verification>
        <tests>
          <test type="unit">
            <file>testing/98_html5_paged_template_refactor.t</file>
            <description>HTML5 paged template consolidation with external CSS.</description>
            <assertions>Paged HTML5 output renders correctly with external layout/content CSS after template merge and cleanup.</assertions>
          </test>
        </tests>
      </verification>
      <r>
        <outcome>DONE</outcome>
        <observations>Consolidated paged CSS into shared layout/content templates, updated bundle output to always externalize CSS, moved minimal templates into testing, and refreshed config docs and tests.</observations>
        <lessons-learned>Shared layout/content templates keep bundled and inline paged output consistent with fewer moving parts.</lessons-learned>
        <files>
          <file>lib/ChordPro/Output/HTML5.pm</file>
          <file>lib/ChordPro/res/templates/html5/paged/css/base.tt</file>
          <file>lib/ChordPro/res/templates/html5/paged/css/layout.tt</file>
          <file>lib/ChordPro/res/templates/html5/paged/css/content.tt</file>
          <file>lib/ChordPro/res/templates/html5/paged/songbook.tt</file>
          <file>lib/ChordPro/res/config/chordpro.json</file>
          <file>lib/ChordPro/res/pod/Config.pod</file>
          <file>lib/ChordPro/Config/Data.pm</file>
          <file>Makefile</file>
          <file>testing/98_html5_paged_template_refactor.t</file>
          <file>testing/templates/html5/paged/songbook-minimal.tt</file>
          <file>testing/templates/html5/paged/css/layout-minimal.tt</file>
          <file>testing/templates/html5/paged/css/content-minimal.tt</file>
          <file>ai-docs/overview-features-bugs.xml</file>
        </files>
      </r>
    </item>

  </items>

  <archive>
  </archive>

  <changelog>
    <entry date="2026-02-08">Initial code analysis; generated overview.xml and created 10 [REF] items.</entry>
    <entry date="2026-02-08">Added bug item for HTML5 image alignment regression (t/85_html5_image_align.t).</entry>
    <entry date="2026-02-08">Item 11 implemented. HTML5 image scaling preserves explicit width/height when scale is provided.</entry>
    <entry date="2026-02-08">Added refactoring item to align HTML5 image scale behavior and tests.</entry>
    <entry date="2026-02-08">Item 12 implemented. Aligned HTML5 image scaling logic and tests for scale-only vs width+scale behavior.</entry>
    <entry date="2026-02-09">Archived items 11 and 12.</entry>
    <entry date="2026-02-11">Added feature item 20 for minimal HTML5 paged bundle output with externalized CSS.</entry>
    <entry date="2026-02-11">Item 20 implemented. Added minimal paged HTML5 bundle output with externalized CSS and a regression test.</entry>
    <entry date="2026-02-11">Added bug item 21 for condensing HTML5 output empty lines.</entry>
    <entry date="2026-02-11">Added refactoring item 22 to remove gray background from HTML5 paged output.</entry>
    <entry date="2026-02-11">Added refactoring item 23 to consolidate HTML5 paged templates and external CSS split.</entry>
    <entry date="2026-02-11">Items 19, 21, 22, 23 implemented. Updated HTML5 paged page breaks, condensed HTML output, removed gray screen background, and consolidated paged templates with external CSS.</entry>
  </changelog>
</implementation-plan>
